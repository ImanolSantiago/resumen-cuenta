AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Resumen de cuentas

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Architectures:
            - x86_64
    Environment:
        Variables:
          REGION : us-east-1

    Handler: app.lambda_handler
    Runtime: python3.9
    Timeout: 180
    #Tags: 
    #  - Key: "project"
    #    Value: "Resumen de Cuenta"

Resources:
  splitterLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./lambdas/python/splitter/src
      Description: Obtiene y parsea la data del CSV e invoca a la lambda "core".
      Environment:
        Variables:
          CORE_LAMBDA : !GetAtt coreLambda.Arn
      Events:
        S3Event:
          Type: S3
          Properties:
              Bucket:
                Ref: S3Bucket
              Events:
                - 's3:ObjectCreated:*'
              Filter:
                S3Key:
                  Rules:
                    - Name: prefix
                      Value: input/
                    - Name: suffix
                      Value: .csv
      FunctionName: splitter

  coreLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./lambdas/python/core
      Description: Recibe DNI, fecha_desde, fecha_hasta. Realiza las consultas necesarias a la DB y genera un json para invocar a "PDFCreator".
      Environment:
        Variables:
          LAMBDA_PDF_CREATE : !GetAtt PDFCreator.Arn
          DB_NAME : XXXXX
          DB_HOST : XXXXX
          DB_USER : XXXXX
          DB_PASSWORD : XXXXX
      FunctionName: core

  #PDFCreatorLambda:
  #  Type: AWS::Serverless::Function
  #  Properties:
  #    CodeUri: ./lambdas/nodeJs/PDFCreator
  #    Description: Recibe un JSON y genera un PDF
  #    Environment:
  #      Variables:
  #        LAMBDA_PDF_CREATE : !GetAtt splitterLambda.Arn
  #        DB_NAME : XXXXX
  #        DB_HOST : XXXXX
  #        DB_USER : XXXXX
  #        DB_PASSWORD : XXXXX
  #    FunctionName: PDFCreator
  #    Runtime: nodejs12.x

  S3Bucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: 'recumen-cuenta-s3'